<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginContainer = document.getElementById('loginContainer');
    const reportFrame = document.getElementById('reportFrame');
    const reportContainer = document.getElementById('reportContainer');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const loginButton = document.getElementById('loginButton');
    const logoutButton = document.getElementById('logoutButton');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginError = document.getElementById('loginError');
    const changePasswordButton = document.getElementById('changePasswordButton');
    const changePasswordModal = document.getElementById('changePasswordModal');
    const currentPasswordInput = document.getElementById('currentPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
    const passwordError = document.getElementById('passwordError');
    const cancelChangePassword = document.getElementById('cancelChangePassword');
    const saveNewPassword = document.getElementById('saveNewPassword');

    const loginTab = document.getElementById('loginTab');
    const registerTab = document.getElementById('registerTab');
    const loginContent = document.getElementById('loginContent');
    const registerContent = document.getElementById('registerContent');
    const registerButton = document.getElementById('registerButton');
    const registerEmail = document.getElementById('registerEmail');
    const registerUsername = document.getElementById('registerUsername');
    const registerPassword = document.getElementById('registerPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const accessCode = document.getElementById('accessCode');
    const registerError = document.getElementById('registerError');

    const reportCodes = {
        '953116': {
            name: 'Power bi Bendito - versão celular',
            url: 'https://app.powerbi.com/view?r=eyJrIjoiYzA1MDI4ZDItNzMyYi00OTZkLWJkMzAtMzg1MDczZGFkNmEzIiwidCI6Ijk2OWI5ZDQ2LTg3MWMtNDNlZS04MTJhLWVmY2FmMGYzMDFhZiJ9'
        },
        '987116': {
            name: 'Power bi Bendito',
            url: 'https://app.powerbi.com/view?r=eyJrIjoiOTU3NTc1YTUtMWJjMS00OTE1LWFjMGMtMzhkZjU4ODdhZWFhIiwidCI6Ijk2OWI5ZDQ2LTg3MWMtNDNlZS04MTJhLWVmY2FmMGYzMDFhZiJ9'
        },
        '940955': {
            name: 'Power bi Bendito - operacional',
            url: 'https://app.powerbi.com/view?r=eyJrIjoiNDUxZjg2ZDctMTk2YS00MDdhLTg3NTUtMmIzYTU2OTVlMTliIiwidCI6Ijk2OWI5ZDQ2LTg3MWMtNDNlZS04MTJhLWVmY2FmMGYzMDFhZiJ9'
        }
    };

    if (!localStorage.getItem('users')) {
        const defaultUsers = {
            'renan': {
                password: '1234',
                email: 'renan@exemplo.com',
                accessCode: '987116'
            },
            'bruno': {
                password: '1234',
                email: 'bruno@exemplo.com',
                accessCode: '987116'
            }
        };
        localStorage.setItem('users', JSON.stringify(defaultUsers));
    }

    function detectDeviceType() {
        const mobileUserAgent = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const smallScreen = window.innerWidth <= 768;
        const touchEnabled = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        return (mobileUserAgent || (smallScreen && touchEnabled)) ? 'mobile' : 'desktop';
    }

    function loadReport(username) {
        loadingOverlay.style.display = 'flex';
        const users = JSON.parse(localStorage.getItem('users'));
        const user = users[username];
        let reportUrl;

        if (user && user.accessCode) {
            if (user.accessCode === '987116') {
                const deviceType = detectDeviceType();
                reportUrl = deviceType === 'mobile' ? reportCodes['953116'].url : reportCodes['987116'].url;
            } else if (reportCodes[user.accessCode]) {
                reportUrl = reportCodes[user.accessCode].url;
            } else {
                const deviceType = detectDeviceType();
                reportUrl = deviceType === 'mobile' ? reportCodes['953116'].url : reportCodes['987116'].url;
            }
        } else {
            const deviceType = detectDeviceType();
            reportUrl = deviceType === 'mobile' ? reportCodes['953116'].url : reportCodes['987116'].url;
        }

        // Ajuste de resolução dinâmica após o carregamento
        reportFrame.src = reportUrl;
        reportFrame.onload = function () {
            setTimeout(function () {
                reportFrame.style.height = reportContainer.offsetHeight + 'px';
                loadingOverlay.style.display = 'none';
            }, 1000);
        };
    }

    function checkLoginStatus() {
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            userName.textContent = currentUser;
            userInfo.classList.remove('hidden');
            loginContainer.classList.add('hidden');
            loadReport(currentUser);
        }
    }

    function login() {
        const username = usernameInput.value.trim().toLowerCase();
        const password = passwordInput.value;
        const users = JSON.parse(localStorage.getItem('users'));

        if (users[username] && users[username].password === password) {
            localStorage.setItem('currentUser', username);
            userName.textContent = username;
            userInfo.classList.remove('hidden');
            loginContainer.classList.add('hidden');
            loadReport(username);
            usernameInput.value = '';
            passwordInput.value = '';
            loginError.classList.remove('visible');
        } else {
            loginError.textContent = 'Usuário ou senha incorretos. Tente novamente.';
            loginError.classList.add('visible');
        }
    }

    function logout() {
        localStorage.removeItem('currentUser');
        userInfo.classList.add('hidden');
        loginContainer.classList.remove('hidden');
        reportFrame.src = 'about:blank';
        loadingOverlay.style.display = 'none';
    }

    checkLoginStatus();
    loginButton.addEventListener('click', login);
    logoutButton.addEventListener('click', logout);
});
</script>
